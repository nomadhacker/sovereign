# installing using deb pkg.  see https://www.tarsnap.com/pkg-deb.html
- name: Download Tarsnap Repository Key
  get_url:
    url: https://pkg.tarsnap.com/tarsnap-deb-packaging-key.asc
    dest: /root/tarsnap-deb-packaging-key.asc

- name: Add the tarsnap code signing key to your list of keys
  command:
    apt-key add tarsnap-deb-packaging-key.asc
    chdir=/root/

- name: Add Tarsnap repository
  apt_repository: repo="deb http://pkg.tarsnap.com/deb/{{ ansible_distribution_release }} ./"

- name: Install Tarsnap
  apt: pkg={{ item }} state=installed update_cache=yes
  with_items:
    - tarsnap

- name: Copy Tarsnap key file into place
  copy: src=decrypted_tarsnap.key dest=/decrypted/tarsnap.key owner=root group=root mode="0600" force=no

- name: Create Tarsnap cache directory
  file: state=directory path=/usr/tarsnap-cache

- name: Install Tarsnap configuration file
  copy: src=tarsnap_conf dest=/etc/tarsnap.conf mode="0644"

- name: Install Tarsnap backup handler script
  copy: src=tarsnap.sh dest=/root/tarsnap.sh mode="0755"

- name: Install nightly Tarsnap-generations cronjob
  cron: name="Tarsnap backup" hour="3" minute="0" job="sh /root/tarsnap.sh >> /var/log/tarsnap.log"
